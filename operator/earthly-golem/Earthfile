#
# Generated by @zondax/cli
#
VERSION 0.7
FROM golang:1.21-alpine
ARG --global BASE_NAME=tororu-operator

RUN apk update \
    && apk --no-cache --update add build-base bash git libstdc++

# Let's unify on a common place
WORKDIR /app

build-base:
    DO ../+GET_SOURCE_CODE
    RUN make build
    SAVE ARTIFACT /app

build-sidecar-postgres-base:
    DO ../+GET_SOURCE_CODE
    RUN cd sidecars && make build
    SAVE ARTIFACT /app

build-production:
    # TODO: Move this to a base image that we use everywhere?
    FROM alpine:3.17

    RUN apk update \
    && apk --no-cache --update add ca-certificates libstdc++

    COPY ./zondax_CA.crt /usr/local/share/ca-certificates/zondax_CA.crt
    RUN update-ca-certificates

    RUN addgroup --system --gid 1001 zondax
    RUN adduser --system --uid 1001 zondax
    USER zondax

    # This could be optimized. Keeping it simple for now
    COPY --chown=zondax:zondax +build-base/app/output /zondax/bin

    EXPOSE 9090

    # TODO: can we ensure that we always have k8s probes?
    CMD ["/zondax/bin/tororu-operator", "start", "-c", "/zondax/config/tororu-operator.yaml"]

    DO ../+PUBLISH_WITH_FLEXTAGS --CONTAINER_FULLNAME=${BASE_NAME}

build-sidecar-postgres:
    # TODO: Move this to a base image that we use everywhere?
    FROM alpine:3.17

    RUN apk update \
    && apk --no-cache --update add ca-certificates postgresql-client libstdc++

    COPY ./zondax_CA.crt /usr/local/share/ca-certificates/zondax_CA.crt
    RUN update-ca-certificates

    RUN addgroup --system --gid 1001 zondax
    RUN adduser --system --uid 1001 zondax
    USER zondax

    # This could be optimized. Keeping it simple for now
    COPY --chown=zondax:zondax +build-sidecar-postgres-base/app/sidecars/output /zondax/bin

    EXPOSE 9090

    RUN touch "/zondax/sidecars.yaml"

    CMD ["/zondax/bin/sidecars", "start-sidecar-postgres", "-c", "/zondax/sidecars.yaml"]

    DO ../+PUBLISH_WITH_FLEXTAGS --CONTAINER_FULLNAME="sidecar-postgres"

all:
    BUILD +build-production
    BUILD +build-sidecar-postgres
